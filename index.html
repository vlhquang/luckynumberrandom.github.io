
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R√∫t Bao L√¨ X√¨ May M·∫Øn - T·∫øt 2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Quicksand:wght@400;600;700&display=swap');

        :root {
            --red-primary: #d32f2f;
            --red-dark: #b71c1c;
            --gold: #ffcf33;
            --gold-dark: #ffa000;
        }

        body {
            background-color: #fff8f8;
            background-image: radial-gradient(#ffcdd2 0.8px, transparent 0.8px);
            background-size: 20px 20px;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Quicksand', sans-serif;
        }

        .font-festive { font-family: 'Montserrat', sans-serif; }
        
        .overlay-blur {
            backdrop-filter: blur(15px);
            background-color: rgba(0, 0, 0, 0.85);
        }

        .confetti-particle {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            animation: fall linear forwards;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        .entrance-pop {
            animation: popUp 0.6s cubic-bezier(0.17, 0.89, 0.32, 1.28) forwards;
        }

        @keyframes popUp {
            from { transform: scale(0.5) translateY(50px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* Hi·ªáu ·ª©ng tia s√°ng qu√©t qua */
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        .shimmer::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@^19.2.4",
        "react/": "https://esm.sh/react@^19.2.4/",
        "react-dom": "https://esm.sh/react-dom@^19.2.4",
        "react-dom/": "https://esm.sh/react-dom@^19.2.4/"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom';

        // --- CONSTANTS ---
        const STORAGE_KEY = 'lixi_v9_consolidated';
        const CONFETTI_COLORS = ['#f44336', '#ffcf33', '#ffa000', '#ffffff', '#e91e63'];

        // --- SERVICES ---
        const calculateAmounts = (total, count, min, max) => {
            const UNIT = 10000;
            if (total % UNIT !== 0 || min % UNIT !== 0 || max % UNIT !== 0) return null;
            const ut = total / UNIT, umin = min / UNIT, umax = max / UNIT;
            const minS = (count * umin) + (count * (count - 1) / 2);
            const maxS = (count * umax) - (count * (count - 1) / 2);
            if (ut < minS || ut > maxS) return null;

            let units = [];
            for (let i = 0; i < count; i++) units.push(umin + i);
            let diff = ut - units.reduce((a, b) => a + b, 0);

            while (diff > 0) {
                let changed = false;
                for (let i = count - 1; i >= 0; i--) {
                    if (diff <= 0) break;
                    const up = (i === count - 1) ? umax : units[i + 1] - 1;
                    const can = up - units[i];
                    if (can > 0) {
                        const add = Math.min(can, diff);
                        units[i] += add; diff -= add; changed = true;
                    }
                }
                if (!changed) break;
            }
            return units.map(u => u * UNIT);
        };

        const formatCurrency = (n) => n.toLocaleString('vi-VN');
        const parseCurrency = (s) => parseInt(s.replace(/\D/g, '')) || 0;

        // --- COMPONENTS ---

        const Confetti = () => {
            const [particles, setParticles] = useState([]);
            useEffect(() => {
                const parts = Array.from({ length: 50 }).map((_, i) => ({
                    id: Date.now() + i,
                    x: Math.random() * 100,
                    color: CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)],
                    duration: 1.5 + Math.random() * 2
                }));
                setParticles(parts);
                const timer = setTimeout(() => setParticles([]), 4000);
                return () => clearTimeout(timer);
            }, []);
            return (
                <>
                    {particles.map(p => (
                        <div key={p.id} className="confetti-particle" style={{
                            left: `${p.x}%`, top: '-20px', width: '8px', height: '8px',
                            backgroundColor: p.color, borderRadius: Math.random() > 0.5 ? '50%' : '0',
                            animationDuration: `${p.duration}s`
                        }} />
                    ))}
                </>
            );
        };

        const LixiCard = ({ amount, isOpen, onOpen }) => (
            <div 
                className={`relative w-full aspect-[3/4.5] cursor-pointer group transition-all duration-500 hover:scale-105 active:scale-95 ${isOpen ? 'opacity-60 grayscale-[0.3]' : ''}`}
                onClick={onOpen}
            >
                <div className="w-full h-full relative rounded-2xl overflow-hidden shadow-xl border-2 border-yellow-400 bg-gradient-to-br from-[#d32f2f] to-[#b71c1c] flex flex-col items-center justify-center shimmer">
                    {isOpen ? (
                        <div className="flex flex-col items-center justify-center p-2 text-center animate-in zoom-in duration-300">
                             <div className="text-yellow-400 font-festive font-black text-sm sm:text-lg leading-none">
                                {formatCurrency(amount)}ƒë
                             </div>
                             <div className="text-white/70 text-[0.6rem] mt-2 font-bold tracking-widest">ƒê√É M·ªû</div>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center justify-center pointer-events-none">
                            <span className="text-4xl sm:text-5xl mb-2 drop-shadow-lg">üßß</span>
                            <span className="text-white font-festive font-black text-xs sm:text-sm tracking-[0.2em] uppercase">L√¨ X√¨</span>
                        </div>
                    )}
                </div>
            </div>
        );

        const SetupScreen = ({ onStart }) => {
            const [totalStr, setTotalStr] = useState('1.000.000');
            const [count, setCount] = useState(10);
            const [minStr, setMinStr] = useState('20.000');
            const [maxStr, setMaxStr] = useState('200.000');
            const [previewAmounts, setPreviewAmounts] = useState([]);

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const c = JSON.parse(saved);
                    setTotalStr(formatCurrency(c.total)); setCount(c.count);
                    setMinStr(formatCurrency(c.min)); setMaxStr(formatCurrency(c.max));
                }
            }, []);

            useEffect(() => {
                const res = calculateAmounts(parseCurrency(totalStr), count, parseCurrency(minStr), parseCurrency(maxStr));
                setPreviewAmounts(res || []);
            }, [totalStr, count, minStr, maxStr]);

            return (
                <div className="bg-white rounded-[2rem] p-8 shadow-2xl border-2 border-red-50 max-w-xl mx-auto w-full animate-in fade-in zoom-in duration-500">
                    <h2 className="text-3xl font-festive font-black text-red-600 mb-8 text-center tracking-tight">C·∫§U H√åNH L·ªòC XU√ÇN</h2>
                    <div className="grid grid-cols-2 gap-6 mb-8">
                        <div className="flex flex-col gap-2">
                            <label className="text-[0.65rem] font-black text-red-800 uppercase tracking-widest">T·ªïng Ng√¢n S√°ch</label>
                            <input type="text" value={totalStr} onChange={e => setTotalStr(formatCurrency(parseCurrency(e.target.value)))} className="p-4 border-2 border-red-50 rounded-2xl bg-red-50/20 font-bold focus:ring-2 focus:ring-red-200 focus:outline-none" />
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="text-[0.65rem] font-black text-red-800 uppercase tracking-widest">S·ªë L∆∞·ª£ng Bao</label>
                            <input type="number" value={count} onChange={e => setCount(parseInt(e.target.value) || 1)} className="p-4 border-2 border-red-50 rounded-2xl bg-red-50/20 font-bold focus:ring-2 focus:ring-red-200 focus:outline-none" />
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="text-[0.65rem] font-black text-red-800 uppercase tracking-widest">L·ªôc T·ªëi Thi·ªÉu</label>
                            <input type="text" value={minStr} onChange={e => setMinStr(formatCurrency(parseCurrency(e.target.value)))} className="p-4 border-2 border-red-50 rounded-2xl bg-red-50/20 font-bold focus:ring-2 focus:ring-red-200 focus:outline-none" />
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="text-[0.65rem] font-black text-red-800 uppercase tracking-widest">L·ªôc T·ªëi ƒêa</label>
                            <input type="text" value={maxStr} onChange={e => setMaxStr(formatCurrency(parseCurrency(e.target.value)))} className="p-4 border-2 border-red-50 rounded-2xl bg-red-50/20 font-bold focus:ring-2 focus:ring-red-200 focus:outline-none" />
                        </div>
                    </div>
                    <div className="flex gap-3">
                        <button onClick={() => {
                            const t = parseCurrency(totalStr); const avg = t / count;
                            setMinStr(formatCurrency(Math.max(10000, Math.floor(avg*0.4/10000)*10000)));
                            setMaxStr(formatCurrency(Math.floor(avg*1.8/10000)*10000));
                        }} className="flex-1 bg-gray-100 text-gray-700 font-bold py-4 rounded-2xl text-xs uppercase tracking-widest hover:bg-gray-200 transition-all active:scale-95">G·ª£i √Ω</button>
                        <button onClick={() => {
                            const config = { total: parseCurrency(totalStr), count, min: parseCurrency(minStr), max: parseCurrency(maxStr) };
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(config)); alert("ƒê√£ l∆∞u!");
                        }} className="flex-1 bg-amber-400 text-amber-900 font-bold py-4 rounded-2xl text-xs uppercase tracking-widest hover:bg-amber-500 transition-all active:scale-95">L∆∞u</button>
                        <button disabled={previewAmounts.length === 0} onClick={() => onStart({ total: parseCurrency(totalStr), count, min: parseCurrency(minStr), max: parseCurrency(maxStr), amounts: previewAmounts })} className={`flex-[1.5] font-black py-4 rounded-2xl text-xs uppercase tracking-[0.2em] transition-all shadow-lg active:scale-95 ${previewAmounts.length > 0 ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>B·∫Øt ƒë·∫ßu üöÄ</button>
                    </div>
                </div>
            );
        };

        const GameScreen = ({ config, onBack }) => {
            const [openStates, setOpenStates] = useState(new Array(config.count).fill(false));
            const [shuffledAmounts, setShuffledAmounts] = useState([]);
            const [triggerConfetti, setTriggerConfetti] = useState(0);
            const [focusedIndex, setFocusedIndex] = useState(null);
            const [isRevealing, setIsRevealing] = useState(false);

            useEffect(() => {
                setShuffledAmounts([...config.amounts].sort(() => Math.random() - 0.5));
            }, [config.amounts]);

            const maxDigitCount = useMemo(() => config.max.toString().length, [config.max]);

            const revealDetails = useMemo(() => {
                if (focusedIndex === null) return { items: [], totalTime: 0 };
                const amountStr = shuffledAmounts[focusedIndex].toString();
                const paddedStr = amountStr.padStart(maxDigitCount, '0');
                const chars = paddedStr.split('');
                const gameFactor = 1 + (openStates.filter(s => s).length / config.count);
                
                let currentDelay = 0;
                const items = chars.map((char, index) => {
                    const reverseIndex = maxDigitCount - 1 - index;
                    const duration = 0.6 * gameFactor + (reverseIndex * 0.75 * gameFactor);
                    return { char, duration, delay: 0 };
                });

                for (let i = maxDigitCount - 1; i >= 0; i--) {
                    items[i].delay = currentDelay;
                    currentDelay += items[i].duration * 0.75;
                }
                return { items, totalTime: currentDelay + 1.2 };
            }, [focusedIndex, shuffledAmounts, openStates, config.count, maxDigitCount]);

            const handleCardClick = (idx) => {
                if (openStates[idx]) return;
                setFocusedIndex(idx); setIsRevealing(false);
                setTimeout(() => setIsRevealing(true), 600);
                setTimeout(() => {
                    setOpenStates(prev => { const n = [...prev]; n[idx] = true; return n; });
                    setTriggerConfetti(p => p + 1);
                }, revealDetails.totalTime * 1000);
            };

            const gridClass = useMemo(() => {
                const n = config.count;
                if (n === 1) return 'grid-cols-1 max-w-xs';
                if (n <= 3) return 'grid-cols-2 sm:grid-cols-3 max-w-xl';
                if (n <= 6) return 'grid-cols-2 sm:grid-cols-3 max-w-2xl';
                if (n <= 12) return 'grid-cols-3 sm:grid-cols-4 md:grid-cols-6 max-w-4xl';
                return 'grid-cols-4 sm:grid-cols-6 md:grid-cols-8 max-w-6xl';
            }, [config.count]);

            return (
                <div className="flex-1 flex flex-col relative h-full animate-in fade-in duration-500">
                    <div key={triggerConfetti}>{triggerConfetti > 0 && <Confetti />}</div>
                    <div className="flex-1 overflow-y-auto px-4 py-10 flex items-center justify-center">
                        <div className={`grid gap-4 w-full mx-auto ${gridClass}`}>
                            {shuffledAmounts.map((amt, idx) => (
                                <LixiCard key={idx} amount={amt} isOpen={openStates[idx]} onOpen={() => handleCardClick(idx)} />
                            ))}
                        </div>
                    </div>

                    {focusedIndex !== null && (
                        <div onClick={() => setFocusedIndex(null)} className="fixed inset-0 z-[100] flex items-center justify-center p-4 overlay-blur animate-in fade-in duration-300 cursor-pointer">
                            <div onClick={e => e.stopPropagation()} className="relative w-full max-w-[400px] aspect-[3/4.8] entrance-pop shadow-[0_0_100px_rgba(211,47,47,0.4)] rounded-[3.5rem] overflow-hidden border-[10px] border-yellow-400 bg-white">
                                <div className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center bg-white z-10">
                                    <div className="w-full flex flex-col items-center">
                                        <div className="flex items-center justify-center w-full h-28 gap-1 px-1">
                                            {revealDetails.items.map((item, i) => (
                                                <div key={i} className="relative flex-1 h-full flex items-center justify-center border-b-4 border-red-50">
                                                    <span className="text-red-600 font-festive font-black text-3xl sm:text-5xl drop-shadow-sm">{item.char}</span>
                                                    <div className="absolute inset-0 bg-gradient-to-b from-[#d32f2f] to-[#b71c1c] z-20 transition-all shadow-lg overflow-hidden"
                                                        style={{
                                                            clipPath: isRevealing ? 'inset(0 0 100% 0)' : 'inset(0 0 0 0)',
                                                            transitionDuration: `${item.duration}s`,
                                                            transitionDelay: `${item.delay}s`,
                                                            transitionTimingFunction: 'cubic-bezier(0.1, 0.7, 0.1, 1)'
                                                        }}>
                                                        <div className="w-full h-full flex items-center justify-center text-yellow-400/30 text-3xl font-festive">Á¶è</div>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="flex items-center justify-center h-full ml-1"><span className="text-red-600 font-festive font-black text-3xl sm:text-5xl">ƒë</span></div>
                                        </div>
                                    </div>
                                    <div className="mt-14 space-y-3">
                                        <div className="text-amber-600 font-black text-[0.6rem] tracking-[0.5em] uppercase opacity-60">L·ªôc Xu√¢n ƒê·∫°i C√°t</div>
                                        <div className="text-red-500 font-festive font-black text-2xl sm:text-4xl uppercase tracking-tighter drop-shadow-md">V·∫†N S·ª∞ NH∆Ø √ù</div>
                                    </div>
                                    <div className="absolute bottom-14 left-0 right-0 text-red-50 text-[16rem] opacity-10 pointer-events-none font-festive flex justify-center">Á¶è</div>
                                    {openStates[focusedIndex] && (
                                        <div className="absolute bottom-10 left-0 right-0 animate-bounce text-red-400 text-[0.7rem] font-black uppercase tracking-[0.4em]">Ch·∫°m ƒë·ªÉ ƒë√≥ng</div>
                                    )}
                                </div>
                            </div>
                            <div className="absolute bottom-10 text-center pointer-events-none">
                                {!openStates[focusedIndex] ? <div className="text-2xl animate-pulse text-yellow-400 font-festive font-bold drop-shadow-lg">ƒêANG GI·∫¢I M√É L·ªòC...</div> : <div className="bg-yellow-400 text-red-900 px-10 py-4 rounded-full font-black text-sm shadow-2xl tracking-widest uppercase border-2 border-white animate-bounce">TUY·ªÜT V·ªúI!</div>}
                            </div>
                        </div>
                    )}

                    <div className="absolute bottom-8 right-8 flex flex-col gap-4 z-50">
                        <button onClick={onBack} className="w-16 h-16 bg-white text-red-600 border-4 border-yellow-400 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 active:scale-90 transition-all"><i className="fa-solid fa-gear"></i></button>
                        <button onClick={() => { setOpenStates(new Array(config.count).fill(false)); setFocusedIndex(null); setTimeout(() => setShuffledAmounts([...config.amounts].sort(() => Math.random() - 0.5)), 400); }} className="w-16 h-16 bg-white text-red-600 border-4 border-yellow-400 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 active:scale-90 transition-all"><i className="fa-solid fa-rotate"></i></button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('setup');
            const [config, setConfig] = useState(null);
            return (
                <div className="min-h-screen flex flex-col w-full overflow-hidden">
                    <header className="py-8 flex flex-col items-center flex-shrink-0">
                        <h1 className="text-5xl font-festive font-black text-red-600 drop-shadow-sm tracking-tighter">L√å X√å <span className="text-amber-500">T·∫æT</span></h1>
                        <div className="h-1.5 w-32 bg-gradient-to-r from-transparent via-yellow-400 to-transparent mt-3"></div>
                    </header>
                    <main className="flex-1 flex flex-col px-4 pb-12 w-full max-w-7xl mx-auto">
                        {view === 'setup' ? <div className="flex-1 flex items-center justify-center"><SetupScreen onStart={c => { setConfig(c); setView('playing'); }} /></div> : config && <GameScreen config={config} onBack={() => setView('setup')} />}
                    </main>
                    <div className="fixed top-4 left-4 p-4 opacity-40 sm:opacity-60 pointer-events-none text-4xl">üèÆ</div>
                    <div className="fixed top-4 right-4 p-4 opacity-40 sm:opacity-60 pointer-events-none text-4xl">üèÆ</div>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
