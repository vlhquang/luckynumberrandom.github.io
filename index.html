
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R√∫t Bao L√¨ X√¨ May M·∫Øn 2025</title>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        :root {
            --red-primary: #d32f2f;
            --red-dark: #b71c1c;
            --gold: #ffcf33;
            --gold-dark: #ffa000;
            --white: #ffffff;
            --bg-color: #fff8f8;
            --shadow: 0 4px 15px rgba(0,0,0,0.15);
            --text-dark: #2c3e50;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* NgƒÉn scroll to√†n trang */
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(#ffcdd2 0.8px, transparent 0.8px);
            background-size: 20px 20px;
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        header {
            text-align: center;
            padding: 10px 0;
            flex-shrink: 0;
        }

        h1 {
            color: var(--red-primary);
            text-shadow: 1px 1px 0px var(--gold);
            font-size: clamp(1.5rem, 6vw, 2.2rem);
            font-weight: 800;
        }

        /* Setup Screen */
        #setup-screen {
            background: var(--white);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 2px solid #ffcdd2;
            overflow-y: auto; /* Cho ph√©p scroll trong box c·∫•u h√¨nh n·∫øu c·∫ßn */
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }

        .form-group { margin-bottom: 5px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; color: var(--red-dark); font-size: 0.75rem; }
        
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #fce4ec;
            border-radius: 10px;
            font-size: 0.9rem;
            background: #ffffff;
            color: var(--text-dark);
            font-weight: 600;
        }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-suggest { background: #607d8b; color: white; }
        .btn-save { background: var(--gold); color: #5d4037; }
        .btn-start { background: var(--red-primary); color: white; }

        .preview-container {
            margin-top: 10px;
            padding: 10px;
            background: #fff9c4;
            border-radius: 12px;
            display: none;
            border: 1px solid var(--gold-dark);
        }
        .preview-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 4px; margin-top: 5px;}
        .preview-item { background: white; padding: 4px; border-radius: 6px; text-align: center; font-size: 0.65rem; color: var(--red-primary); border: 1px solid #ffe082; }

        /* Game Screen - Fill viewport */
        #game-screen { 
            display: none; 
            flex: 1;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        /* Floating Controls */
        .bubble-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .bubble-btn {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25); border: 3px solid var(--gold);
            background: var(--white); cursor: pointer;
            font-size: 1.2rem;
        }

        .lixi-grid {
            display: grid;
            gap: 12px;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-content: center; /* Gom c√°c bao l√¨ x√¨ l·∫°i trung t√¢m */
            padding: 10px;
        }

        .lixi-wrapper {
            width: 100%;
            max-width: 180px; /* TƒÉng max-width ƒë·ªÉ bao l√¨ x√¨ to h∆°n */
            aspect-ratio: 3 / 4.3;
            perspective: 1000px;
            cursor: pointer;
            margin: 0 auto;
            transition: transform 0.2s;
        }
        .lixi-wrapper:active { transform: scale(0.95); }

        .lixi-card {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .lixi-wrapper.open .lixi-card { transform: rotateY(180deg); }

        .lixi-front, .lixi-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 3px solid var(--gold);
        }

        .lixi-front { background: linear-gradient(135deg, var(--red-primary), var(--red-dark)); color: var(--gold); }
        .lixi-front::before { content: 'üßß'; font-size: clamp(1.8rem, 8vw, 3.5rem); }
        .lixi-front::after { content: 'L√¨ x√¨'; font-weight: 700; font-size: 0.8rem; margin-top: 6px; }

        .lixi-back { background: #fff; color: var(--red-dark); transform: rotateY(180deg); padding: 8px; text-align: center; }
        .amount-text { font-size: clamp(0.8rem, 3.5vw, 1.3rem); font-weight: 900; color: var(--red-primary); line-height: 1.1; }
        .congrats-text { font-size: 0.6rem; color: var(--gold-dark); font-weight: 700; margin-top: 6px; line-height: 1.2; }

        .confetti { position: fixed; width: 6px; height: 6px; z-index: 9999; pointer-events: none; }
        
        @keyframes popOut { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .animate-pop { animation: popOut 0.4s ease; }

        /* Responsive Grid Logic */
        @media (max-width: 480px) {
            .lixi-grid { gap: 10px; }
            .lixi-wrapper { max-width: 140px; }
            /* Force 2 columns on small screens to fill width and height better */
            .grid-2cols { grid-template-columns: repeat(2, 1fr) !important; }
            .grid-3cols { grid-template-columns: repeat(3, 1fr) !important; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header id="main-header">
            <h1>L√å X√å T·∫æT 2025</h1>
        </header>

        <!-- Setup Area -->
        <div id="setup-screen" class="card">
            <div class="form-grid">
                <div class="form-group">
                    <label>T·ªïng ng√¢n s√°ch (VND)</label>
                    <input type="text" id="total-amount" value="1.000.000" class="money-input">
                </div>
                <div class="form-group">
                    <label>S·ªë bao l√¨ x√¨</label>
                    <input type="number" id="envelope-count" value="10" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>L·ªôc t·ªëi thi·ªÉu (VND)</label>
                    <input type="text" id="min-val" value="20.000" class="money-input">
                </div>
                <div class="form-group">
                    <label>L·ªôc t·ªëi ƒëa (VND)</label>
                    <input type="text" id="max-val" value="200.000" class="money-input">
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn-suggest" id="btn-suggest">‚ú® G·ª£i √Ω</button>
                <button type="button" class="btn-save" id="btn-save">üíæ L∆∞u</button>
                <button type="button" class="btn-start" id="btn-start-game">üöÄ B·∫Øt ƒë·∫ßu</button>
            </div>

            <div id="preview-container" class="preview-container">
                <div id="preview-total" style="text-align:center; font-weight:bold; color:var(--red-primary); font-size: 0.9rem;"></div>
                <div id="preview-list" class="preview-list"></div>
            </div>
        </div>

        <!-- Game Area -->
        <div id="game-screen">
            <div class="lixi-grid" id="lixi-grid"></div>
            <div class="bubble-controls">
                <button class="bubble-btn" id="btn-back" title="C·∫•u h√¨nh">‚öôÔ∏è</button>
                <button class="bubble-btn" id="btn-shuffle" title="L√†m m·ªõi">üîÑ</button>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            let config = { total: 1000000, count: 10, min: 20000, max: 200000, amounts: [] };

            function formatNum(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
            function parseNum(s) { return parseInt(s.replace(/\./g, '')) || 0; }

            $(document).on('input', '.money-input', function() {
                let v = $(this).val().replace(/\D/g, '');
                $(this).val(v ? formatNum(parseInt(v)) : '');
                updatePreview();
            });
            $('#envelope-count').on('input', updatePreview);

            function calculate(total, count, min, max) {
                if (total % 10000 !== 0 || min % 10000 !== 0 || max % 10000 !== 0) return null;
                const ut = total / 10000, umin = min / 10000, umax = max / 10000;
                const minS = (count * umin) + (count * (count - 1) / 2);
                const maxS = (count * umax) - (count * (count - 1) / 2);
                if (ut < minS || ut > maxS) return null;

                let units = [];
                for (let i = 0; i < count; i++) units.push(umin + i);
                let diff = ut - units.reduce((a, b) => a + b, 0);

                while (diff > 0) {
                    let changed = false;
                    for (let i = count - 1; i >= 0; i--) {
                        if (diff <= 0) break;
                        let up = (i === count - 1) ? umax : units[i + 1] - 1;
                        let can = up - units[i];
                        if (can > 0) {
                            let add = Math.min(can, diff);
                            units[i] += add; diff -= add; changed = true;
                        }
                    }
                    if (!changed) break;
                }
                return units.map(u => u * 10000);
            }

            function updatePreview() {
                const total = parseNum($('#total-amount').val());
                const count = parseInt($('#envelope-count').val());
                const min = parseNum($('#min-val').val());
                const max = parseNum($('#max-val').val());
                const res = calculate(total, count, min, max);
                if (res) {
                    config = { total, count, min, max, amounts: res };
                    $('#preview-total').text(`T·ªïng c·ªông: ${formatNum(res.reduce((a,b)=>a+b,0))}ƒë`);
                    const $list = $('#preview-list').empty();
                    [...res].sort(()=>Math.random()-0.5).forEach(amt => $list.append(`<div class="preview-item">${formatNum(amt)}ƒë</div>`));
                    $('#preview-container').show();
                    return true;
                }
                $('#preview-container').hide();
                return false;
            }

            $('#btn-suggest').click(() => {
                const t = parseNum($('#total-amount').val()) || 1000000;
                const c = parseInt($('#envelope-count').val()) || 10;
                const avg = t / c;
                $('#min-val').val(formatNum(Math.max(10000, Math.floor(avg * 0.4 / 10000) * 10000)));
                $('#max-val').val(formatNum(Math.floor(avg * 1.8 / 10000) * 10000));
                updatePreview();
            });

            $('#btn-save').click(() => {
                if (updatePreview()) {
                    localStorage.setItem('lixi_v6_final', JSON.stringify({t:config.total, c:config.count, mn:config.min, mx:config.max}));
                    alert("C·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c l∆∞u!");
                }
            });

            $('#btn-start-game').click(() => {
                if (updatePreview()) {
                    $('#setup-screen, #main-header').fadeOut(300, () => {
                        $('#game-screen').css('display', 'flex').hide().fadeIn(300);
                        renderGame();
                    });
                } else { alert("C·∫•u h√¨nh ch∆∞a h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i ng√¢n s√°ch v√† s·ªë l∆∞·ª£ng."); }
            });

            $('#btn-back').click(() => {
                $('#game-screen').fadeOut(300, () => $('#main-header, #setup-screen').fadeIn(300));
            });

            $('#btn-shuffle').click(() => {
                $('.lixi-wrapper').removeClass('open');
                setTimeout(renderGame, 400);
            });

            function renderGame() {
                const $grid = $('#lixi-grid').empty();
                const n = config.count;
                
                $grid.removeClass('grid-2cols grid-3cols');

                // Intelligent column selection to fill the screen
                let cols = 2;
                if (window.innerWidth <= 480) {
                    // Mobile
                    if (n <= 4) cols = 2;
                    else if (n <= 9) cols = 3;
                    else if (n <= 12) { cols = 3; $grid.addClass('grid-3cols'); }
                    else if (n <= 16) cols = 4;
                    else if (n <= 25) cols = 5;
                    else cols = 6;
                } else {
                    // Tablet/Desktop
                    if (n <= 4) cols = n;
                    else if (n <= 10) cols = 5;
                    else if (n <= 20) cols = 6;
                    else cols = 10;
                }
                
                $grid.css('grid-template-columns', `repeat(${cols}, 1fr)`);
                
                const randomized = [...config.amounts].sort(() => Math.random() - 0.5);
                randomized.forEach(amt => {
                    const $el = $(`
                        <div class="lixi-wrapper">
                            <div class="lixi-card">
                                <div class="lixi-front"></div>
                                <div class="lixi-back">
                                    <div class="amount-text">${formatNum(amt)}ƒë</div>
                                    <div class="congrats-text">An khang th·ªãnh v∆∞·ª£ng - V·∫°n s·ª± nh∆∞ √Ω</div>
                                </div>
                            </div>
                        </div>
                    `);
                    $grid.append($el);
                    $el.click(function() {
                        if (!$(this).hasClass('open')) {
                            $(this).addClass('open').find('.lixi-card').addClass('animate-pop');
                            const colors = ['#f44336', '#ffcf33', '#ffa000', '#ffffff'];
                            for (let i = 0; i < 20; i++) {
                                const $c = $('<div class="confetti"></div>').css({
                                    left: Math.random() * window.innerWidth, top: -10,
                                    backgroundColor: colors[Math.floor(Math.random() * colors.length)]
                                });
                                $('body').append($c);
                                $c.animate({ top: window.innerHeight + 20, opacity: 0 }, 800 + Math.random() * 800, function() { $(this).remove(); });
                            }
                        }
                    });
                });
            }

            const saved = localStorage.getItem('lixi_v6_final');
            if (saved) {
                const s = JSON.parse(saved);
                $('#total-amount').val(formatNum(s.t)); $('#envelope-count').val(s.c);
                $('#min-val').val(formatNum(s.mn)); $('#max-val').val(formatNum(s.mx));
            }
            updatePreview();
        });
    </script>
</body>
</html>
