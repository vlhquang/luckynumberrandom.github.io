<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>L√¨ x√¨ T·∫øt 2026 - Final Mobile Fix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        :root { --red-primary: #d00000; --red-dark: #8e0000; --gold: #ffd700; --bg-cream: #fffdf5; }
        body { margin: 0; padding: 0; background-color: var(--red-dark); font-family: 'Montserrat', sans-serif; overflow-x: hidden; min-height: 100vh; background-image: radial-gradient(circle at center, #b71c1c 0%, #7f1d1d 100%); -webkit-tap-highlight-color: transparent; user-select: none; }
        .font-festive { font-family: 'Dancing Script', cursive; }
        #fireworks-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        .premium-input { background: #fff; border: 2px solid #fbbf24; color: #b91c1c; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s; font-size: 1.1rem; }
        .btn-action { transition: all 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); touch-action: manipulation; }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        
        /* TOAST NOTIFICATION */
        #toast-msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 10000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #toast-msg.show { opacity: 1; }

        /* CUSTOM SCROLLBAR CHO MODAL */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ffd700; border-radius: 4px; }

        /* CARD STYLES */
        .lixi-wrapper { transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); will-change: transform; touch-action: manipulation; }
        .lixi-wrapper:active { transform: scale(0.95) !important; }
        
        .shimmer { position: relative; overflow: hidden; }
        .shimmer::after { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform: rotate(45deg); animation: shimmer 3s infinite; }
        
        .lixi-opened { pointer-events: none; transform: scale(0.95); opacity: 1; }
        .lixi-opened .front-ui { display: none !important; }
        .lixi-opened .back-ui { display: flex !important; opacity: 1 !important; }

        .separator-box { width: 10px !important; }
        
        /* Bong b√≥ng tho·∫°i */
        .speech-bubble { position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%) scale(0); background: #fff; color: #d00000; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: bold; white-space: nowrap; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 20; transition: transform 0.2s; pointer-events: none; }
        .speech-bubble::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #fff transparent transparent transparent; }
        .wiggling { animation: wiggle 0.5s ease-in-out; }
        .wiggling .speech-bubble { transform: translateX(-50%) scale(1); }
        @keyframes wiggle { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }

        /* SCRATCH CANVAS */
        #scratch-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; cursor: pointer; touch-action: none; border-radius: 1rem; }
        
        #scratch-area { 
            position: relative; width: 100%; height: 120px; 
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; border-radius: 1rem; background: #fffdf5; 
            margin-top: 15px; margin-bottom: 15px;
        }

        #digit-container { position: relative; z-index: 10; opacity: 0; transition: opacity 0.2s; }
        #digit-container .digit-box span { font-size: 2.5rem; }
        @media (min-width: 640px) { #digit-container .digit-box span { font-size: 3.5rem; } }

        /* AUTO REVEAL ANIMATION */
        .digit-reveal-cover { clip-path: inset(0 0 0 0); transition: clip-path 0.5s cubic-bezier(0.4, 0, 0.2, 1); background-color: #fffdf5; position: absolute; inset: 0; z-index: 30; }
        .digit-box.revealed .digit-reveal-cover { clip-path: inset(0 0 100% 0); }

        /* JACKPOT STYLES */
        .jackpot-revealed #reveal-card-content { background: linear-gradient(135deg, #fff 0%, #ffd700 100%) !important; border-color: #fff !important; box-shadow: 0 0 80px rgba(255, 215, 0, 0.9) !important; transition: all 0.8s ease; }
        .jackpot-badge { animation: pulse-gold 1s infinite; }
        @keyframes pulse-gold { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Dealing Card */
        .dealing-card { position: fixed; top: 50%; left: 50%; width: 80px; height: 120px; background: linear-gradient(135deg, #d00000 0%, #8e0000 100%); border: 2px solid #ffd700; border-radius: 0.8rem; transform: translate(-50%, -50%) scale(0.5); transition: all 0.6s; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
        .dealing-card span { font-size: 2rem; color: #ffd700; font-family: 'Dancing Script'; font-weight: bold; }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="toast-msg">ƒê√£ l∆∞u c·∫•u h√¨nh!</div>
    <canvas id="fireworks-canvas"></canvas>

    <div class="container mx-auto px-3 py-4 flex flex-col items-center max-w-6xl min-h-screen relative z-10">
        <header id="main-header" class="text-center mb-2 transition-all duration-500 pt-safe">
            <h1 class="text-4xl sm:text-5xl font-festive font-bold text-yellow-400 drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]">
                L√¨ X√¨ <span class="text-white">T·∫øt</span>
            </h1>
            <p class="text-yellow-200/80 text-[0.6rem] sm:text-[0.65rem] font-bold tracking-[0.3em] uppercase mt-1">V·∫°n s·ª± nh∆∞ √Ω ‚Ä¢ T·ª∑ s·ª± nh∆∞ m∆°</p>
        </header>

        <main class="w-full flex justify-center items-center flex-1 pb-24 sm:pb-16">
            <div id="setup-screen" class="bg-[#fffdf5] rounded-[2rem] p-5 sm:p-6 shadow-2xl w-full max-w-md border-4 border-yellow-400 mb-8 max-h-[85vh] overflow-y-auto custom-scrollbar">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase ml-1">T·ªïng ti·ªÅn</label><input type="text" id="total-input" value="500.000" class="premium-input w-full p-3 rounded-xl font-bold text-center outline-none text-sm" inputmode="numeric"/></div>
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase ml-1">S·ªë bao</label><input type="number" id="count-input" value="8" min="2" max="50" class="premium-input w-full p-3 rounded-xl font-bold text-center outline-none text-sm" inputmode="numeric"/></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Min</label><input type="text" id="min-input" value="10.000" class="premium-input w-full p-3 rounded-xl font-bold text-center outline-none text-sm" inputmode="numeric"/></div>
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Max</label><input type="text" id="max-input" value="100.000" class="premium-input w-full p-3 rounded-xl font-bold text-center outline-none text-sm" inputmode="numeric"/></div>
                    </div>
                    
                    <div class="flex gap-2 pt-1">
                        <button id="btn-suggest-minmax" class="btn-action flex-1 bg-blue-50 text-blue-800 py-3 rounded-xl font-bold text-[10px] border border-blue-200 uppercase">G·ª£i √Ω Min/Max</button>
                        <button id="btn-suggest-total" class="btn-action flex-1 bg-green-50 text-green-800 py-3 rounded-xl font-bold text-[10px] border border-green-200 uppercase">G·ª£i √Ω T·ªïng</button>
                    </div>

                    <div class="flex items-center justify-between bg-yellow-50 p-3 rounded-xl border border-yellow-200 mt-2">
                        <span class="text-xs font-bold text-red-700 uppercase flex items-center gap-2">
                            <i class="fa-solid fa-hand-sparkles"></i> Ch·∫ø ƒë·ªô C√†o
                        </span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-scratch" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                        </label>
                    </div>
                </div>

                <div class="mt-4 flex gap-3">
                     <button id="btn-save-config" class="flex-1 btn-action bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-bold text-xs sm:text-sm uppercase shadow-lg"><i class="fa-solid fa-floppy-disk mr-2"></i> L∆∞u C·∫•u H√¨nh</button>
                </div>

                <div class="mt-3 border-t border-red-100 pt-4">
                    <button id="btn-generate" class="w-full btn-action bg-yellow-400 text-red-900 py-3 rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg">Xem tr∆∞·ªõc</button>
                </div>
                
                <div id="error-msg" class="hidden mt-4 p-3 bg-red-100 text-red-600 rounded-xl text-center text-xs font-bold"></div>
                
                <div id="review-section" class="hidden mt-4 bg-white rounded-xl border-2 border-red-200 overflow-hidden shadow-inner">
                    <div class="bg-red-50 p-2 border-b border-red-100 flex justify-between items-center"><span class="text-[10px] font-bold text-red-700 uppercase">Chi ti·∫øt</span><span class="text-[9px] font-bold bg-green-100 text-green-800 px-2 py-0.5 rounded-full">OK</span></div>
                    <div id="preview-list" class="p-3 grid grid-cols-3 gap-2"></div>
                    <div class="p-2 bg-gray-50 flex gap-2 border-t border-gray-200">
                        <button id="btn-reroll-setup" class="flex-1 bg-white border border-gray-300 text-gray-600 py-2 rounded-lg font-bold text-xs">ƒê·ªïi s·ªë</button>
                        <button id="btn-confirm-start" class="flex-[1.5] bg-red-600 text-white py-2 rounded-lg font-bold text-xs uppercase shadow-md animate-pulse">B·∫Øt ƒë·∫ßu</button>
                    </div>
                </div>
            </div>

            <div id="game-screen" class="hidden w-full flex-col items-center justify-center min-h-[60vh]">
                <div class="w-full max-w-5xl px-1">
                    <div id="lixi-grid" class="grid grid-cols-2 min-[500px]:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4 justify-items-center pb-safe"></div>
                </div>
                
                <div class="fixed bottom-6 right-4 flex flex-col gap-3 z-50 pb-safe">
                    <button id="btn-config" class="w-11 h-11 bg-white text-red-600 rounded-full shadow-2xl flex items-center justify-center text-lg border-2 border-yellow-400 active:scale-90"><i class="fa-solid fa-gear"></i></button>
                    <button id="btn-reroll-game" class="w-11 h-11 bg-blue-500 text-white rounded-full shadow-2xl flex items-center justify-center text-lg border-2 border-white active:scale-90"><i class="fa-solid fa-dice"></i></button>
                    <button id="btn-shuffle" class="w-11 h-11 bg-yellow-400 text-red-700 rounded-full shadow-2xl flex items-center justify-center text-lg border-2 border-white active:scale-90"><i class="fa-solid fa-rotate"></i></button>
                </div>
            </div>
        </main>
    </div>

    <div id="reveal-overlay" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 overlay-blur cursor-pointer">
        <div id="reveal-card-content" class="relative w-[90%] max-w-[340px] entrance-pop bg-[#fffdf5] rounded-[2rem] border-[6px] border-yellow-400 shadow-[0_0_60px_rgba(255,215,0,0.5)] overflow-hidden flex flex-col items-center text-center transition-all duration-700">
            <div id="jackpot-decor" class="hidden absolute inset-0 pointer-events-none"><div class="absolute inset-0 bg-gradient-to-b from-yellow-300/30 to-transparent"></div></div>
            <div class="w-full pt-5 px-4 pb-1 z-10">
                <div id="jackpot-badge" class="hidden mb-1 opacity-0 transition-opacity duration-500">
                    <span class="bg-red-600 text-yellow-300 border border-yellow-300 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg">‚òÖ ƒê·ªôc ƒê·∫Øc ‚òÖ</span>
                </div>
                <div id="label-lixi" class="text-red-400 font-bold text-xs tracking-[0.3em] uppercase opacity-80 transition-colors duration-500">L·ªôc Xu√¢n</div>
            </div>
            <div id="scratch-area" class="shadow-inner border border-yellow-100 relative bg-white cursor-crosshair">
                <div id="digit-container" class="flex items-center justify-center gap-px font-mono select-none pointer-events-none opacity-0"></div>
                <canvas id="scratch-canvas" class="hidden"></canvas>
            </div>
            <div class="w-full pb-5 px-4 z-20 flex flex-col items-center justify-center min-h-[90px]">
                <div class="pointer-events-none select-none mb-2">
                    <h3 class="text-lg font-festive text-yellow-600 font-black mb-0">V·∫°n S·ª±</h3>
                    <h2 class="text-2xl font-festive text-red-600 font-black">Nh∆∞ √ù</h2>
                </div>
                <div id="status-decoding" class="h-10 flex items-center justify-center">
                    <span id="txt-guide" class="text-gray-400 font-bold text-[10px] animate-pulse">üëá C√†o nh·∫π l·ªõp b·∫°c ·ªü tr√™n üëá</span>
                </div>
                <button id="btn-claim-l·ªôc" class="hidden w-full bg-gradient-to-r from-yellow-400 to-orange-500 h-10 rounded-xl text-red-900 font-black text-base uppercase tracking-wider shadow-lg animate-bounce">NH·∫¨N L·ªòC</button>
                <div id="tap-hint" class="hidden text-[9px] text-gray-400 mt-2 uppercase animate-pulse">(Ch·∫°m b·∫•t k·ª≥ ƒë√¢u ƒë·ªÉ ƒë√≥ng)</div>
            </div>
        </div>
    </div>

    <div id="animation-layer" class="fixed inset-0 pointer-events-none z-[9000]"></div>

    <script>
        $(function() {
            let config = { total: 0, count: 0, min: 0, max: 0, amounts: [], scratchMode: true };
            let openStates = [];
            let shuffledAmounts = [];
            let currentOpeningIdx = null;
            let canCloseOverlay = false;
            let idleInterval = null;
            let isScratchingComplete = false;

            const loadConfig = () => {
                const saved = localStorage.getItem('lixiConfig2026');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        $('#total-input').val(parsed.total);
                        $('#count-input').val(parsed.count);
                        $('#min-input').val(parsed.min);
                        $('#max-input').val(parsed.max);
                        $('#toggle-scratch').prop('checked', parsed.scratchMode);
                        config.scratchMode = parsed.scratchMode;
                    } catch(e) {}
                }
            };
            loadConfig();

            $('#btn-save-config').click(() => {
                const data = {
                    total: $('#total-input').val(),
                    count: $('#count-input').val(),
                    min: $('#min-input').val(),
                    max: $('#max-input').val(),
                    scratchMode: $('#toggle-scratch').is(':checked')
                };
                localStorage.setItem('lixiConfig2026', JSON.stringify(data));
                const $toast = $('#toast-msg');
                $toast.addClass('show');
                setTimeout(() => $toast.removeClass('show'), 2000);
            });

            const canvasFireworks = document.getElementById('fireworks-canvas');
            const ctxFireworks = canvasFireworks.getContext('2d');
            let particles = [];
            function resizeCanvas() { canvasFireworks.width = window.innerWidth; canvasFireworks.height = window.innerHeight; }
            window.addEventListener('resize', resizeCanvas); resizeCanvas();
            function createParticle(x, y, count=20) {
                for (let i=0; i<count; i++) particles.push({x, y, color: ['#f00','#ffd700','#fff'][Math.floor(Math.random()*3)], radius: Math.random()*2+1, velocity: {x:(Math.random()-0.5)*8, y:(Math.random()-0.5)*8}, alpha: 1, decay: 0.03});
            }
            function animateFireworks() {
                ctxFireworks.clearRect(0,0,canvasFireworks.width,canvasFireworks.height);
                particles.forEach((p,i)=>{ p.velocity.y+=0.05; p.x+=p.velocity.x; p.y+=p.velocity.y; p.alpha-=p.decay; if(p.alpha<=0) particles.splice(i,1); else { ctxFireworks.save(); ctxFireworks.globalAlpha=p.alpha; ctxFireworks.fillStyle=p.color; ctxFireworks.beginPath(); ctxFireworks.arc(p.x,p.y,p.radius,0,Math.PI*2); ctxFireworks.fill(); ctxFireworks.restore(); } });
                requestAnimationFrame(animateFireworks);
            }
            animateFireworks();
            function launchFireworks(intensity=1) { let dur = intensity>1?4000:2000; let inter = setInterval(()=>createParticle(Math.random()*canvasFireworks.width, Math.random()*canvasFireworks.height*0.5, 20),300); setTimeout(()=>clearInterval(inter), dur); }

            const formatVN = (n) => new Intl.NumberFormat('vi-VN').format(n);
            const parseVN = (s) => parseInt(s.replace(/[^0-9]/g, '')) || 0;
            const distributeUnique = (total, count, min, max) => {
                const UNIT = 10000;
                if (total%UNIT!==0 || min%UNIT!==0 || max%UNIT!==0 || count<2) return {success:false, msg:"L·ªói th√¥ng s·ªë"};
                for (let i=0; i<2000; i++) {
                    let set = new Set([min, max]);
                    while(set.size<count) set.add(Math.floor(Math.random()*((max-min)/UNIT+1))*UNIT+min);
                    let arr = Array.from(set).sort((a,b)=>a-b), diff = total - arr.reduce((a,b)=>a+b,0);
                    if(diff!==0) {
                        let ids = [...Array(count-2).keys()].map(x=>x+1).sort(()=>Math.random()-0.5);
                        for(let k of ids) {
                            if(diff===0) break;
                            if(diff>0){ let s=Math.min(diff, Math.ceil((arr[k+1]-arr[k]-UNIT)/UNIT)*UNIT); if(arr[k]+s>=arr[k+1]) s=arr[k+1]-arr[k]-UNIT; if(s>0){arr[k]+=s; diff-=s;} }
                            else { let s=Math.min(Math.abs(diff), Math.ceil((arr[k]-arr[k-1]-UNIT)/UNIT)*UNIT); if(arr[k]-s<=arr[k-1]) s=arr[k]-arr[k-1]-UNIT; if(s>0){arr[k]-=s; diff+=s;} }
                        }
                    }
                    if(arr.reduce((a,b)=>a+b,0)===total && new Set(arr).size===count) return {success:true, amounts:arr};
                }
                return {success:false, msg:"Kh√¥ng chia ƒë∆∞·ª£c"};
            };

            $('#toggle-scratch').change(function() { config.scratchMode = this.checked; });
            config.scratchMode = $('#toggle-scratch').is(':checked');
            $('#btn-suggest-minmax').click(() => { const t=parseVN($('#total-input').val()), c=parseInt($('#count-input').val()); if(t>0&&c>1){ let avg=t/c, mn=Math.max(10000,Math.floor(avg*0.4/10000)*10000), mx=Math.ceil(avg*1.8/10000)*10000; if(mx<mn+c*10000) mx=mn+c*10000+20000; $('#min-input').val(formatVN(mn)); $('#max-input').val(formatVN(mx)); } });
            $('#btn-suggest-total').click(() => { const c=parseInt($('#count-input').val()), mn=parseVN($('#min-input').val()), mx=parseVN($('#max-input').val()); if(c>1&&mn<mx){ let s=new Set([mn,mx]); while(s.size<c) s.add(Math.floor(Math.random()*((mx-mn)/10000+1))*10000+mn); $('#total-input').val(formatVN(Array.from(s).reduce((a,b)=>a+b,0))); } });
            $('.premium-input').on('input', function() { if(this.id!=='count-input') $(this).val(formatVN(parseVN($(this).val()))); });
            
            const generateAndReview = () => {
                const t=parseVN($('#total-input').val()), c=parseInt($('#count-input').val()), mn=parseVN($('#min-input').val()), mx=parseVN($('#max-input').val());
                const res = distributeUnique(t, c, mn, mx);
                if(res.success) {
                    $('#error-msg').addClass('hidden'); $('#preview-list').empty();
                    res.amounts.forEach(amt => $('#preview-list').append(`<div class="preview-item border ${(amt===mn||amt===mx)?'bg-yellow-100 border-yellow-300':'bg-gray-50 border-gray-200'} rounded-lg py-1 px-1 text-center shadow-sm"><div class="text-[9px] font-bold text-gray-400 uppercase">L√¨ x√¨</div><div class="text-[10px] font-black">${formatVN(amt)}</div></div>`));
                    config = { ...config, total:t, count:c, min:mn, max:mx, amounts:res.amounts}; $('#review-section').removeClass('hidden'); return true;
                } else { $('#review-section').addClass('hidden'); $('#error-msg').removeClass('hidden').text(res.msg); return false; }
            };

            $('#btn-generate, #btn-reroll-setup').click(generateAndReview);
            $('#btn-confirm-start').click(() => { $('#setup-screen').fadeOut(300,()=>{ $('#game-screen').removeClass('hidden').fadeIn(300).css('display','flex'); startDealAnimation(); }); });
            $('#btn-config').click(() => { $('#game-screen').fadeOut(300,()=>{ $('#setup-screen').fadeIn(300); $('#game-screen').addClass('hidden'); stopIdleAnimation(); }); });
            $('#btn-shuffle').click(()=>startDealAnimation());
            $('#btn-reroll-game').click(()=>{ const res=distributeUnique(config.total,config.count,config.min,config.max); if(res.success){config.amounts=res.amounts; startDealAnimation();} });

            const startIdleAnimation = () => { stopIdleAnimation(); idleInterval = setInterval(() => { const idxs = openStates.map((s,i)=>s?-1:i).filter(i=>i!==-1); if(idxs.length){ const id=idxs[Math.floor(Math.random()*idxs.length)]; $(`#slot-${id} .lixi-wrapper`).addClass('wiggling'); setTimeout(()=>$(`#slot-${id} .lixi-wrapper`).removeClass('wiggling'),600); } }, 2500); };
            const stopIdleAnimation = () => { if(idleInterval) clearInterval(idleInterval); };

            const startDealAnimation = () => {
                stopIdleAnimation(); $('#lixi-grid').empty(); openStates=new Array(config.count).fill(false); shuffledAmounts=[...config.amounts].sort(()=>Math.random()-0.5);
                shuffledAmounts.forEach((a,i)=>$('#lixi-grid').append(`<div id="slot-${i}" class="w-full aspect-[2/3] max-w-[130px] opacity-0 flex items-center justify-center"></div>`)); 
                const cx=window.innerWidth/2, cy=window.innerHeight/2;
                shuffledAmounts.forEach((amt, i) => {
                    const $flyer = $(`<div class="dealing-card"><span>Á¶è</span></div>`).appendTo('#animation-layer');
                    const $slot = $(`#slot-${i}`);
                    setTimeout(() => {
                        let rect = $slot[0].getBoundingClientRect();
                        $flyer.css({transform:`translate(${rect.left+rect.width/2-cx}px, ${rect.top+rect.height/2-cy}px) scale(1)`, opacity:1});
                        setTimeout(() => {
                            $flyer.remove();
                            const txt = ["Ch·ªçn tui!", "Tui n√®!", "Ti·ªÅn ƒë√¢y!", "M·ªü ngay!"][Math.floor(Math.random()*4)];
                            $slot.empty().append(`<div class="lixi-wrapper relative w-full h-full cursor-pointer"><div class="speech-bubble">${txt}</div><div class="w-full h-full rounded-xl bg-gradient-to-br from-red-600 to-red-800 border-2 border-yellow-400 shadow-md flex flex-col items-center justify-center shimmer relative"><div class="front-ui absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-red-600 to-red-800 z-10"><div class="w-12 h-12 rounded-full border-2 border-yellow-200 bg-red-700 flex items-center justify-center mb-1 shadow-inner"><span class="text-yellow-400 font-festive text-2xl font-bold">T·∫øt</span></div><span class="text-white text-[8px] uppercase tracking-widest opacity-80">May M·∫Øn</span></div><div class="back-ui hidden absolute inset-0 bg-white flex-col items-center justify-center p-1 z-20"><span class="text-red-600 font-black text-lg text-center leading-tight">${formatVN(amt)}<br><span class="text-[8px] text-gray-400">VNƒê</span></span></div></div></div>`).css('opacity',1);
                            $slot.find('.lixi-wrapper').click(()=>handleOpen(i));
                        }, 500);
                    }, i*100);
                });
                setTimeout(startIdleAnimation, config.count*100+1000);
            };

            const initScratchCard = () => {
                const canvas = document.getElementById('scratch-canvas');
                const area = document.getElementById('scratch-area');
                const ctx = canvas.getContext('2d');
                const w = area.offsetWidth || 300; 
                const h = area.offsetHeight || 120;
                canvas.width = w; canvas.height = h;

                ctx.globalCompositeOperation = 'source-over';
                const grd = ctx.createLinearGradient(0, 0, w, h); grd.addColorStop(0, '#e0e0e0'); grd.addColorStop(0.5, '#ffffff'); grd.addColorStop(1, '#a0a0a0');
                ctx.fillStyle = grd; ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = '#999'; ctx.font = 'bold 16px Montserrat'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('üëã C√ÄO NH·∫∏ üëã', w/2, h/2);

                const scratch = (x, y) => { 
                    ctx.globalCompositeOperation = 'destination-out'; 
                    for(let i=0; i<15; i++) {
                         const r = 2 + Math.random() * 5; 
                         ctx.beginPath();
                         ctx.arc(x + (Math.random()-0.5)*15, y + (Math.random()-0.5)*15, r, 0, Math.PI * 2);
                         ctx.fill();
                    }
                    checkScratchCompletion(); 
                };

                let isDrawing = false;
                const getPos = (e) => { const rect = canvas.getBoundingClientRect(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; return { x: cx - rect.left, y: cy - rect.top }; };
                ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, (e) => { isDrawing = true; const p = getPos(e); scratch(p.x, p.y); }));
                ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, (e) => { if (isDrawing) { e.preventDefault(); const p = getPos(e); scratch(p.x, p.y); } }));
                ['mouseup', 'touchend'].forEach(evt => canvas.addEventListener(evt, () => isDrawing = false));

                let checkThrottled = false;
                const checkScratchCompletion = () => {
                    if (isScratchingComplete || checkThrottled) return;
                    checkThrottled = true; setTimeout(() => checkThrottled = false, 200);
                    const pixels = ctx.getImageData(0, 0, w, h).data;
                    let t = 0; for (let i = 3; i < pixels.length; i += 4) if (pixels[i] < 128) t++;
                    if ((t / (pixels.length / 4)) * 100 > 30) finishReveal();
                };
                
                $('#digit-container').css('opacity', 1);
            };

            const finishReveal = () => {
                isScratchingComplete = true;
                const canvas = document.getElementById('scratch-canvas');
                if(config.scratchMode && canvas) {
                     const ctx = canvas.getContext('2d');
                     ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                $('#status-decoding').hide();
                $('#btn-claim-l·ªôc').fadeIn();
                $('#tap-hint').fadeIn();
                const isJackpot = (shuffledAmounts[currentOpeningIdx] === config.max);
                if(isJackpot) {
                    $('#reveal-overlay').addClass('jackpot-revealed'); 
                    $('#jackpot-badge').removeClass('hidden').removeClass('opacity-0');
                    launchFireworks(2);
                    $('#label-lixi').text("CH√öC M·ª™NG").addClass("text-yellow-600").removeClass("text-red-400");
                } else {
                    launchFireworks(1);
                }
                canCloseOverlay = true;
            };

            const handleOpen = (idx) => {
                if(openStates[idx]) return;
                currentOpeningIdx = idx;
                canCloseOverlay = false;
                isScratchingComplete = false;
                const amount = shuffledAmounts[idx];
                const amountStr = formatVN(amount);

                $('#reveal-overlay').removeClass('hidden jackpot-revealed').hide().fadeIn(200).css('display', 'flex');
                $('#digit-container').empty();
                $('#btn-claim-l·ªôc, #tap-hint').hide();
                $('#status-decoding').show();
                $('#label-lixi').text("L·ªôc Xu√¢n").removeClass("text-yellow-600").addClass("text-red-400");
                $('#jackpot-badge').addClass('hidden').addClass('opacity-0');
                $('#digit-container').css('opacity', 0);

                const chars = amountStr.split('');
                chars.forEach((char) => {
                    const isSep = char === '.';
                    const coverHtml = config.scratchMode ? '' : '<div class="digit-reveal-cover absolute inset-0 z-20"></div>';
                    $('#digit-container').append(`<div class="digit-box relative ${isSep?'separator-box':'w-5 sm:w-8'} h-10 sm:h-16 flex items-center justify-center overflow-hidden"><span class="relative z-10 text-[#d00000] font-bold ${isSep?'text-2xl':'text-4xl sm:text-5xl'} leading-none">${char}</span>${coverHtml}</div>`);
                });
                $('#digit-container').append(`<span class="text-[#d00000] text-2xl sm:text-3xl font-bold mt-2 ml-1">ƒë</span>`);

                if (config.scratchMode) {
                    $('#scratch-canvas').removeClass('hidden');
                    $('#txt-guide').text('üëá C√†o nh·∫π l·ªõp b·∫°c ·ªü tr√™n üëá').addClass('animate-pulse');
                    setTimeout(initScratchCard, 300); 
                } else {
                    $('#digit-container').css('opacity', 1);
                    $('#scratch-canvas').addClass('hidden');
                    $('#txt-guide').text('ƒêANG M·ªû...').addClass('animate-bounce');
                    $('.digit-box').each(function(i) {
                         const delay = (chars.length - 1 - i) * 150;
                         setTimeout(() => $(this).addClass('revealed'), delay);
                    });
                    setTimeout(finishReveal, (chars.length * 150) + 500);
                }
            };

            const closeAndClaim = () => {
                if(!canCloseOverlay) return;
                openStates[currentOpeningIdx] = true;
                const $c = $(`#slot-${currentOpeningIdx} .lixi-wrapper`);
                $c.addClass('lixi-opened').find('.front-ui').addClass('hidden');
                $c.find('.back-ui').removeClass('hidden').addClass('flex');
                if(shuffledAmounts[currentOpeningIdx] === config.max) {
                     $c.find('.back-ui').css({ 'background': '#fff9c4', 'border': '2px solid #ffd700', 'color': '#d00000' });
                }
                $('#reveal-overlay').fadeOut();
            };

            $('#btn-claim-l·ªôc, #reveal-overlay').click((e) => { if(canCloseOverlay) closeAndClaim(); });
            $('#reveal-card-content').click((e) => { 
                if(config.scratchMode && !isScratchingComplete) e.stopPropagation(); 
                else if(canCloseOverlay) closeAndClaim(); 
            });
        });
    </script>
</body>
</html>
