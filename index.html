
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√¨ X√¨ T·∫øt - V·∫°n S·ª± Nh∆∞ √ù</title>
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        :root {
            --red-primary: #d32f2f;
            --red-dark: #b71c1c;
            --gold: #ffcf33;
            --gold-light: #fff9f0;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--gold-light);
            font-family: 'Montserrat', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .font-festive {
            font-family: 'Dancing Script', cursive;
        }

        /* Confetti Animation */
        .confetti-particle {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        /* Overlay */
        .overlay-blur {
            backdrop-filter: blur(25px);
            background: rgba(0, 0, 0, 0.88);
            display: none; /* jQuery control */
        }

        .entrance-pop {
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
        }
        @keyframes pop {
            from { transform: scale(0.6); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Shimmer Effect */
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        .shimmer::after {
            content: "";
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.15), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        /* Digit Reveal Logic */
        .digit-reveal-cover {
            clip-path: inset(0 0 0 0);
            transition-property: clip-path;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        .digit-box.revealed .digit-reveal-cover {
            clip-path: inset(0 0 100% 0);
        }

        .lixi-opened {
            opacity: 0.5;
            filter: grayscale(0.8);
            pointer-events: none;
        }

        .custom-shadow-reveal {
            box-shadow: 0 0 120px rgba(255, 207, 51, 0.25);
        }

        .btn-gold-gradient {
            background: linear-gradient(180deg, #ffcf33 0%, #ffa000 100%);
            box-shadow: 0 10px 40px rgba(255, 160, 0, 0.6);
        }

        /* Hide scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

    <div class="container mx-auto px-4 py-8 flex flex-col items-center max-w-4xl min-h-screen">
        <!-- Header -->
        <header id="main-header" class="text-center mb-8 flex flex-col items-center">
            <h1 class="text-5xl sm:text-7xl font-festive font-black text-[#d32f2f] drop-shadow-sm tracking-tighter">
                L√å X√å <span class="text-[#ffa000]">T·∫æT</span>
            </h1>
            <div class="h-1.5 w-32 bg-gradient-to-r from-transparent via-[#ffcf33] to-transparent mt-3"></div>
            <p class="text-red-800 font-bold tracking-[0.3em] uppercase text-[0.6rem] sm:text-xs opacity-70 mt-2">
                Ch√∫c M·ª´ng NƒÉm M·ªõi ‚Ä¢ V·∫°n S·ª± Nh∆∞ √ù
            </p>
        </header>

        <!-- Main Content Wrapper -->
        <main class="w-full flex justify-center items-center flex-1 overflow-hidden">
            <!-- SETUP SCREEN -->
            <div id="setup-screen" class="bg-white rounded-[2.5rem] p-8 shadow-2xl border-2 border-red-100 max-w-2xl mx-auto w-full overflow-y-auto max-h-[85vh]">
                <h2 class="text-3xl font-festive font-extrabold text-[#d32f2f] mb-8 text-center uppercase tracking-tight">C·∫•u h√¨nh L√¨ X√¨</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
                    <div class="flex flex-col gap-2">
                        <label class="text-xs font-bold text-red-800 uppercase tracking-widest">T·ªïng ng√¢n s√°ch (VNƒê)</label>
                        <input type="text" id="total-input" value="1.000.000" class="money-input p-4 border-2 border-red-50 rounded-2xl bg-red-50/30 font-bold focus:outline-none focus:border-red-300 transition-colors text-center" />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-xs font-bold text-red-800 uppercase tracking-widest">S·ªë bao l√¨ x√¨</label>
                        <input type="number" id="count-input" value="10" min="1" max="100" class="p-4 border-2 border-red-50 rounded-2xl bg-red-50/30 font-bold focus:outline-none focus:border-red-300 transition-colors text-center" />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-xs font-bold text-red-800 uppercase tracking-widest">L·ªôc t·ªëi thi·ªÉu (VNƒê)</label>
                        <input type="text" id="min-input" value="20.000" class="money-input p-4 border-2 border-red-50 rounded-2xl bg-red-50/30 font-bold focus:outline-none focus:border-red-300 transition-colors text-center" />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-xs font-bold text-red-800 uppercase tracking-widest">L·ªôc t·ªëi ƒëa (VNƒê)</label>
                        <input type="text" id="max-input" value="200.000" class="money-input p-4 border-2 border-red-50 rounded-2xl bg-red-50/30 font-bold focus:outline-none focus:border-red-300 transition-colors text-center" />
                    </div>
                </div>

                <div class="flex flex-wrap gap-3 mb-8">
                    <button id="btn-suggest" class="flex-1 min-w-[120px] bg-slate-500 hover:bg-slate-600 text-white font-bold py-4 rounded-2xl transition-all shadow-md active:scale-95 flex items-center justify-center gap-2 text-xs uppercase tracking-widest">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> G·ª£i √Ω
                    </button>
                    <button id="btn-save" class="flex-1 min-w-[120px] bg-yellow-400 hover:bg-yellow-500 text-amber-900 font-bold py-4 rounded-2xl transition-all shadow-md active:scale-95 flex items-center justify-center gap-2 text-xs uppercase tracking-widest">
                        <i class="fa-solid fa-floppy-disk"></i> L∆∞u
                    </button>
                    <button id="btn-start" class="flex-1 min-w-[120px] bg-red-600 hover:bg-red-700 text-white font-black py-4 rounded-2xl transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2 text-xs uppercase tracking-[0.2em]">
                        <i class="fa-solid fa-rocket"></i> B·∫Øt ƒë·∫ßu
                    </button>
                </div>

                <div id="preview-box" class="hidden bg-yellow-50 border border-yellow-200 rounded-3xl p-6 mb-6">
                    <div id="preview-header" class="text-center font-black text-red-700 text-sm mb-4 uppercase tracking-widest">Ph√¢n b·ªï d·ª± ki·∫øn</div>
                    <div id="preview-list" class="grid grid-cols-2 xs:grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3"></div>
                </div>

                <div id="history-box" class="hidden bg-red-50 border border-red-100 rounded-3xl p-6">
                    <div class="text-center font-black text-red-700 text-sm mb-4 uppercase tracking-widest">L·ªãch s·ª≠ nh·∫≠n l·ªôc</div>
                    <div id="history-list" class="flex flex-col gap-2 max-h-48 overflow-y-auto pr-2"></div>
                </div>

                <div id="error-msg" class="hidden text-center p-5 bg-red-50 text-red-500 rounded-2xl text-xs font-bold uppercase tracking-widest leading-relaxed mt-4">
                    Th√¥ng s·ªë kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i ng√¢n s√°ch.<br/>(Y√™u c·∫ßu: B·ªôi s·ªë c·ªßa 10.000ƒë)
                </div>
            </div>

            <!-- GAME SCREEN -->
            <div id="game-screen" class="hidden w-full flex flex-col items-center">
                <div id="lixi-grid" class="grid gap-4 w-full mx-auto justify-items-center p-4"></div>
                
                <div class="fixed bottom-8 right-8 flex flex-col gap-5 z-50">
                    <button id="btn-config" title="C·∫•u h√¨nh" class="w-16 h-16 bg-white text-red-600 border-4 border-yellow-400 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform active:scale-90">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <button id="btn-shuffle" title="L√†m m·ªõi" class="w-16 h-16 bg-white text-red-600 border-4 border-yellow-400 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform active:scale-90">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>
        </main>

        <footer class="mt-8 py-4 text-red-800/20 text-[0.6rem] font-bold uppercase tracking-[0.5em] text-center">
            Ch√∫c M·ª´ng NƒÉm M·ªõi &copy; 2025
        </footer>
    </div>

    <!-- REVEAL OVERLAY (Initial state hidden via Tailwind hidden) -->
    <div id="reveal-overlay" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 overlay-blur">
        <div id="reveal-card" class="relative w-full max-w-[420px] aspect-[3/4.8] entrance-pop custom-shadow-reveal rounded-[3.5rem] overflow-hidden border-[10px] border-yellow-400 bg-white">
            <div class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center bg-white z-10">
                <!-- Stars corners -->
                <div class="absolute top-8 left-8 text-yellow-500 text-2xl opacity-40">‚ùà</div>
                <div class="absolute top-8 right-8 text-yellow-500 text-2xl opacity-40">‚ùà</div>
                <div class="absolute bottom-20 left-8 text-yellow-500 text-2xl opacity-40">‚ùà</div>
                <div class="absolute bottom-20 right-8 text-yellow-500 text-2xl opacity-40">‚ùà</div>

                <div class="w-full h-32 flex items-center justify-center mb-6">
                    <div id="digit-container" class="flex items-center justify-center w-full h-full gap-2 px-2">
                        <!-- Digits boxes go here -->
                    </div>
                </div>

                <div class="mt-4 flex flex-col items-center gap-1">
                    <div class="text-amber-600 font-bold text-xs sm:text-sm tracking-[0.5em] uppercase opacity-70">L·ªôc xu√¢n ƒë·∫°i c√°t</div>
                    <div class="text-red-500 font-black text-2xl sm:text-4xl mt-1 uppercase tracking-tighter drop-shadow-md">PH√ÅT T√ÄI PH√ÅT L·ªòC</div>
                </div>
                
                <div class="absolute bottom-24 left-0 right-0 text-red-50 text-[18rem] opacity-10 pointer-events-none select-none font-festive flex justify-center leading-none">Á¶è</div>
                
                <div id="reveal-tap-hint" class="absolute bottom-16 left-0 right-0 text-red-400 text-[0.7rem] font-black uppercase tracking-[0.4em] px-4 opacity-50">
                    CH·∫†M ƒê·ªÇ HO√ÄN T·∫§T
                </div>

                <!-- Input name field -->
                <div id="receiver-input-container" class="hidden absolute bottom-28 w-[80%] z-20">
                    <input type="text" id="receiver-name" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n..." class="w-full p-4 border-2 border-yellow-200 rounded-2xl bg-yellow-50/50 text-red-700 font-bold text-center focus:outline-none focus:border-yellow-400 transition-all text-sm shadow-inner" />
                </div>
            </div>
        </div>
        
        <div id="reveal-status-area" class="mt-12 flex flex-col items-center gap-6 w-full">
            <div id="status-decoding">
                <span class="text-4xl text-yellow-400 font-festive font-bold italic tracking-widest drop-shadow-[0_0_10px_rgba(255,207,51,0.5)] animate-pulse">ƒêang khai l·ªôc...</span>
            </div>
            <button id="btn-claim-l·ªôc" class="hidden btn-gold-gradient text-red-900 px-16 py-5 rounded-full font-black text-sm tracking-widest uppercase border-2 border-white transition-all hover:scale-110 active:scale-95 animate-bounce">
                NH·∫¨N L·ªòC NGAY!
            </button>
        </div>
    </div>

    <!-- Lantern Decor -->
    <div class="fixed top-0 left-0 p-6 pointer-events-none opacity-20 sm:opacity-40 text-5xl">üèÆ</div>
    <div class="fixed top-0 right-0 p-6 pointer-events-none opacity-20 sm:opacity-40 text-5xl">üèÆ</div>

    <!-- APP LOGIC -->
    <script>
        $(function() {
            const STORAGE_KEY = 'lixi_pure_v4';
            let config = { total: 1000000, count: 10, min: 20000, max: 200000, amounts: [] };
            let openStates = [];
            let shuffledAmounts = [];
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY + '_history')) || [];
            let currentOpeningIdx = null;

            const formatVN = (n) => new Intl.NumberFormat('vi-VN').format(n);
            const parseVN = (s) => parseInt(s.replace(/[^0-9]/g, '')) || 0;

            const distributeAmounts = (total, count, min, max) => {
                const UNIT = 10000;
                if (total % UNIT !== 0 || min % UNIT !== 0 || max % UNIT !== 0) return null;
                if (min * count > total || max * count < total) return null;

                let amounts = new Array(count).fill(min);
                let remaining = total - (min * count);

                for (let i = 0; i < 5000 && remaining > 0; i++) {
                    let idx = Math.floor(Math.random() * count);
                    let canAdd = max - amounts[idx];
                    if (canAdd > 0) {
                        let step = Math.min(remaining, canAdd, UNIT * (Math.floor(Math.random() * 3) + 1));
                        amounts[idx] += step;
                        remaining -= step;
                    }
                }
                for (let i = 0; i < count && remaining > 0; i++) {
                    let canAdd = max - amounts[i];
                    if (canAdd > 0) {
                        let add = Math.min(remaining, canAdd);
                        amounts[i] += add;
                        remaining -= add;
                    }
                }
                return remaining === 0 ? amounts : null;
            };

            const triggerConfetti = () => {
                const colors = ['#f44336', '#ffcf33', '#ffa000', '#ffffff', '#e91e63'];
                for (let i = 0; i < 50; i++) {
                    const $p = $('<div class="confetti-particle"></div>').css({
                        left: Math.random() * 100 + '%',
                        top: '-20px', width: '8px', height: '8px',
                        backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                        borderRadius: Math.random() > 0.5 ? '50%' : '0',
                        animationDuration: (1.5 + Math.random() * 2) + 's',
                        animationDelay: (Math.random() * 0.5) + 's'
                    });
                    $('body').append($p);
                    setTimeout(() => $p.remove(), 4000);
                }
            };

            const updateHistoryUI = () => {
                if (history.length > 0) {
                    $('#history-box').removeClass('hidden');
                    const $list = $('#history-list').empty();
                    [...history].reverse().forEach((item) => {
                        $list.append(`
                            <div class="flex justify-between items-center bg-white/90 p-3 rounded-xl border border-red-50 shadow-sm mb-1">
                                <span class="text-red-700 font-bold text-xs uppercase">${item.name || 'Ng∆∞·ªùi may m·∫Øn'}</span>
                                <span class="text-amber-600 font-black text-sm">+${formatVN(item.amount)}ƒë</span>
                            </div>
                        `);
                    });
                } else {
                    $('#history-box').addClass('hidden');
                }
            };

            const handleUpdatePreview = () => {
                const t = parseVN($('#total-input').val());
                const c = parseInt($('#count-input').val()) || 0;
                const mn = parseVN($('#min-input').val());
                const mx = parseVN($('#max-input').val());
                const res = distributeAmounts(t, c, mn, mx);
                if (res) {
                    $('#error-msg').addClass('hidden');
                    $('#preview-box').removeClass('hidden');
                    $('#preview-header').text(`Ph√¢n b·ªï d·ª± ki·∫øn (T·ªïng: ${formatVN(t)}ƒë)`);
                    const $list = $('#preview-list').empty();
                    [...res].sort((a,b) => b-a).forEach(amt => {
                        $list.append(`<div class="bg-white px-2 py-2 rounded-xl text-[0.7rem] text-center border border-yellow-100 text-red-600 font-black shadow-sm">${formatVN(amt)}ƒë</div>`);
                    });
                    config = { total: t, count: c, min: mn, max: mx, amounts: res };
                    return true;
                } else {
                    $('#preview-box').addClass('hidden');
                    $('#error-msg').removeClass('hidden');
                    return false;
                }
            };

            $('.money-input').on('input', function() {
                $(this).val(formatVN(parseVN($(this).val())));
                handleUpdatePreview();
            });
            $('#count-input').on('input', handleUpdatePreview);

            $('#btn-suggest').click(() => {
                const t = parseVN($('#total-input').val()) || 1000000;
                const c = parseInt($('#count-input').val()) || 10;
                const avg = t / c;
                $('#min-input').val(formatVN(Math.max(10000, Math.floor(avg * 0.4 / 10000) * 10000)));
                $('#max-input').val(formatVN(Math.floor(avg * 2.0 / 10000) * 10000));
                handleUpdatePreview();
            });

            $('#btn-save').click(() => {
                if (handleUpdatePreview()) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
                    alert("ƒê√£ l∆∞u c·∫•u h√¨nh!");
                }
            });

            $('#btn-start').click(() => {
                if (handleUpdatePreview()) {
                    $('#main-header, #setup-screen').fadeOut(300, () => {
                        $('#game-screen').fadeIn(300);
                        renderGrid();
                    });
                }
            });

            $('#btn-config').click(() => {
                $('#game-screen').fadeOut(300, () => $('#main-header, #setup-screen').fadeIn(300));
            });

            $('#btn-shuffle').click(() => {
                $('.lixi-wrapper').addClass('opacity-0 scale-90');
                setTimeout(renderGrid, 300);
            });

            const renderGrid = () => {
                const $grid = $('#lixi-grid').empty();
                const n = config.count;
                openStates = new Array(n).fill(false);
                shuffledAmounts = [...config.amounts].sort(() => Math.random() - 0.5);
                let gridClass = 'grid-cols-2 sm:grid-cols-4 md:grid-cols-5';
                if (n === 1) gridClass = 'grid-cols-1';
                else if (n <= 3) gridClass = 'grid-cols-2 sm:grid-cols-3';
                $grid.attr('class', `grid gap-4 w-full mx-auto max-w-6xl animate-in fade-in duration-500 ${gridClass}`);
                shuffledAmounts.forEach((amt, idx) => {
                    const $card = $(`
                        <div class="lixi-wrapper relative w-full aspect-[3/4.5] max-w-[160px] cursor-pointer group transition-all duration-300 hover:scale-105 active:scale-95">
                            <div class="w-full h-full relative rounded-3xl overflow-hidden shadow-lg border-2 border-[#ffcf33] bg-[#d32f2f] flex flex-col items-center justify-center shimmer">
                                <div class="front-ui flex flex-col items-center justify-center pointer-events-none">
                                    <div class="w-14 h-14 bg-gradient-to-br from-pink-500 to-red-600 rounded-2xl flex items-center justify-center mb-3 shadow-inner border border-red-400">
                                        <span class="text-yellow-400 text-2xl font-bold">Á¶è</span>
                                    </div>
                                    <span class="text-white font-bold text-xs tracking-widest uppercase">L√¨ X√¨</span>
                                </div>
                                <div class="back-ui hidden flex flex-col items-center justify-center p-2 text-center">
                                     <div class="text-yellow-400 font-festive font-black text-lg sm:text-xl leading-none">${formatVN(amt)}ƒë</div>
                                     <div class="text-white/60 text-[0.6rem] mt-2 font-bold uppercase tracking-widest">ƒê√£ m·ªü</div>
                                </div>
                            </div>
                        </div>
                    `);
                    $grid.append($card);
                    $card.click(() => handleOpen(idx, $card));
                });
            };

            const handleOpen = (idx, $card) => {
                if (openStates[idx]) return;
                currentOpeningIdx = idx;
                
                const amount = shuffledAmounts[idx];
                const amountStr = amount.toString();
                // Ensure at least 5 digits for layout consistency
                const maxValDigits = Math.max(5, amountStr.length);
                const paddedStr = amountStr.padStart(maxValDigits, '0');
                const chars = paddedStr.split('');
                
                const $digitContainer = $('#digit-container').empty();
                const $overlay = $('#reveal-overlay').removeClass('hidden').css('display', 'flex').hide().fadeIn(400);
                const $decoding = $('#status-decoding').show();
                const $claimBtn = $('#btn-claim-l·ªôc').hide();
                const $hint = $('#reveal-tap-hint').show();
                const $inputContainer = $('#receiver-input-container').hide();
                $('#receiver-name').val('');

                const digitElements = chars.map((char, i) => {
                    const reverseIdx = maxValDigits - 1 - i;
                    const duration = 0.8 + (reverseIdx * 0.4);
                    const $box = $(`
                        <div class="digit-box relative flex-1 h-full flex items-center justify-center border-b-4 border-red-50 bg-white overflow-hidden">
                            <span class="text-red-600 font-festive font-[900] text-3xl sm:text-5xl drop-shadow-sm">${char}</span>
                            <div class="digit-reveal-cover absolute inset-0 bg-[#d32f2f] z-20 transition-all flex items-center justify-center border border-red-800" 
                                 style="transition-duration: ${duration}s">
                                <span class="text-yellow-400/30 text-2xl font-festive select-none">Á¶è</span>
                            </div>
                        </div>
                    `);
                    $digitContainer.append($box);
                    return { $el: $box, duration };
                });

                $digitContainer.append('<div class="flex items-center justify-center h-full ml-1"><span class="text-red-600 font-festive font-[900] text-3xl sm:text-5xl">ƒë</span></div>');

                // Sequence Reveal logic
                let maxFinalTime = 0;
                setTimeout(() => {
                    digitElements.forEach((d, i) => {
                        const reverseIdx = maxValDigits - 1 - i;
                        const delay = reverseIdx * 0.45;
                        const totalTime = delay + d.duration;
                        if (totalTime > maxFinalTime) maxFinalTime = totalTime;

                        d.$el.find('.digit-reveal-cover').css('transition-delay', delay + 's');
                        // Use microtask or minimal timeout to ensure transitions are ready
                        setTimeout(() => d.$el.addClass('revealed'), 100);
                    });

                    // Final state transition
                    setTimeout(() => {
                        $decoding.fadeOut(300, () => {
                            $claimBtn.fadeIn(400);
                            $inputContainer.fadeIn(400);
                            $hint.fadeOut(400);
                            triggerConfetti();
                        });
                    }, (maxFinalTime * 1000) + 400);
                }, 600);
            };

            $('#btn-claim-l·ªôc').click(function(e) {
                e.stopPropagation();
                const idx = currentOpeningIdx;
                const name = $('#receiver-name').val().trim();
                const amount = shuffledAmounts[idx];
                history.push({ name, amount, timestamp: Date.now() });
                localStorage.setItem(STORAGE_KEY + '_history', JSON.stringify(history));
                openStates[idx] = true;
                const $card = $('.lixi-wrapper').eq(idx);
                $card.addClass('lixi-opened');
                $card.find('.front-ui').hide();
                $card.find('.back-ui').removeClass('hidden');
                updateHistoryUI();
                $('#reveal-overlay').fadeOut(400, () => $('#reveal-overlay').addClass('hidden'));
            });

            $('#reveal-card').click(e => e.stopPropagation());

            // --- Init ---
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const s = JSON.parse(savedData);
                $('#total-input').val(formatVN(s.total));
                $('#count-input').val(s.count);
                $('#min-input').val(formatVN(s.min));
                $('#max-input').val(formatVN(s.max));
            }
            handleUpdatePreview();
            updateHistoryUI();
        });
    </script>
</body>
</html>
