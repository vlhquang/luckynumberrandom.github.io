
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R√∫t Bao L√¨ X√¨ May M·∫Øn</title>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        :root {
            --red-primary: #d32f2f;
            --red-dark: #b71c1c;
            --gold: #ffcf33;
            --gold-dark: #ffa000;
            --white: #ffffff;
            --bg-color: #fff8f8;
            --shadow: 0 4px 20px rgba(0,0,0,0.15);
            --text-dark: #2c3e50;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(#ffcdd2 0.8px, transparent 0.8px);
            background-size: 20px 20px;
            color: var(--text-dark);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1 {
            color: var(--red-primary);
            text-shadow: 1px 1px 0px var(--gold);
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 5px;
            font-weight: 800;
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: clamp(10px, 3vw, 25px);
            box-shadow: var(--shadow);
            margin-bottom: 10px;
            border: 2px solid #ffcdd2;
        }

        /* Form Styling */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .form-group { margin-bottom: 8px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; color: var(--red-dark); font-size: 0.75rem; }
        
        input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #fce4ec;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: #ffffff;
            color: var(--text-dark);
            font-weight: 600;
        }
        input:focus { 
            border-color: var(--red-primary); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        .money-input {
            color: var(--red-primary);
        }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            min-width: 100px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-suggest { background: #607d8b; color: white; }
        .btn-save { background: var(--gold); color: #5d4037; }
        .btn-start { background: var(--red-primary); color: white; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        /* Preview Area */
        .preview-container {
            margin-top: 10px;
            padding: 10px;
            background: #fff9c4;
            border-radius: 12px;
            display: none;
            border: 1px solid var(--gold-dark);
        }
        .preview-header {
            margin-bottom: 3px;
            font-weight: 800;
            color: var(--red-dark);
            font-size: 0.75rem;
            text-align: center;
        }
        .preview-total {
            text-align: center;
            font-size: 0.9rem;
            font-weight: 900;
            color: var(--red-primary);
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dashed rgba(211, 47, 47, 0.2);
        }
        .preview-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
        }
        .preview-item {
            background: white;
            padding: 5px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--red-primary);
            border: 1px solid #ffe082;
        }

        /* Game UI */
        #game-screen { 
            display: none; 
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px; 
        }
        
        .bubble-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        .bubble-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
            border: 2px solid var(--gold);
            padding: 0;
            min-width: unset;
            flex: none;
        }

        .btn-settings { background: #607d8b; color: white; }
        .btn-refresh { background: var(--red-primary); color: white; }

        .lixi-grid {
            display: grid;
            gap: 8px;
            justify-items: center;
            width: 100%;
            margin: auto 0;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        }

        .grid-small .lixi-wrapper { max-width: 120px; }
        .grid-medium .lixi-wrapper { max-width: 80px; }
        .grid-large .lixi-wrapper { max-width: 60px; }

        @media (min-width: 768px) {
            .lixi-grid { gap: 15px; }
            .grid-small .lixi-wrapper { max-width: 160px; }
            .grid-medium .lixi-wrapper { max-width: 110px; }
            .grid-large .lixi-wrapper { max-width: 85px; }
            .bubble-btn { width: 60px; height: 60px; font-size: 1.5rem; }
        }

        .lixi-wrapper {
            width: 100%;
            aspect-ratio: 3 / 4.5;
            perspective: 1000px;
            cursor: pointer;
        }

        .lixi-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .lixi-wrapper.open .lixi-card {
            transform: rotateY(180deg);
        }

        .lixi-front, .lixi-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border: 2px solid var(--gold);
        }

        .lixi-front {
            background: linear-gradient(135deg, var(--red-primary), var(--red-dark));
            color: var(--gold);
        }

        .lixi-front::before {
            content: 'üßß';
            font-size: clamp(1.2rem, 4vw, 2.5rem);
        }
        .lixi-front::after {
            content: 'L√¨ x√¨';
            font-weight: 600;
            font-size: clamp(0.5rem, 2vw, 0.9rem);
            text-align: center;
        }

        .grid-large .lixi-front::after { display: none; }

        .lixi-back {
            background: #fff;
            color: var(--red-dark);
            transform: rotateY(180deg);
            padding: 5px;
            text-align: center;
        }

        .amount-text {
            font-size: clamp(0.6rem, 2.5vw, 1.1rem);
            font-weight: 800;
            color: var(--red-primary);
            line-height: 1.1;
        }

        .congrats-text {
            font-size: clamp(0.4rem, 1.5vw, 0.7rem);
            color: var(--gold-dark);
            font-weight: 600;
            margin-top: 2px;
        }

        .confetti {
            position: fixed;
            width: 6px;
            height: 6px;
            z-index: 9999;
            pointer-events: none;
        }

        @keyframes popOut {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: popOut 0.4s ease; }

        .hidden { display: none !important; }
    </style>
<script type="importmap">
{
  "imports": {
    "jquery": "https://esm.sh/jquery@^4.0.0"
  }
}
</script>
</head>
<body>

    <div class="container">
        <header id="main-header">
            <h1>L√å X√å T·∫æT</h1>
        </header>

        <!-- Configuration Screen -->
        <div id="setup-screen" class="card">
            <div class="form-grid">
                <div class="form-group">
                    <label>T·ªïng ng√¢n s√°ch (VND)</label>
                    <input type="text" id="total-amount" value="1.000.000" class="money-input">
                </div>
                <div class="form-group">
                    <label>S·ªë bao l√¨ x√¨</label>
                    <input type="number" id="envelope-count" value="10" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>L·ªôc t·ªëi thi·ªÉu (VND)</label>
                    <input type="text" id="min-val" value="20.000" class="money-input">
                </div>
                <div class="form-group">
                    <label>L·ªôc t·ªëi ƒëa (VND)</label>
                    <input type="text" id="max-val" value="200.000" class="money-input">
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn-suggest" id="btn-suggest">‚ú® G·ª£i √Ω</button>
                <button type="button" class="btn-save" id="btn-save">üíæ L∆∞u</button>
                <button type="button" class="btn-start" id="btn-start-game">üöÄ B·∫Øt ƒë·∫ßu</button>
            </div>

            <div id="preview-container" class="preview-container">
                <div class="preview-header">Danh s√°ch l·ªôc d·ª± ki·∫øn:</div>
                <div id="preview-total" class="preview-total">T·ªïng c·ªông: 0ƒë</div>
                <div id="preview-list" class="preview-list"></div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" style="display: none;">
            <div class="bubble-controls">
                <button class="bubble-btn btn-settings" id="btn-back" title="C·∫•u h√¨nh">‚öôÔ∏è</button>
                <button class="bubble-btn btn-refresh" id="btn-shuffle" title="L√†m m·ªõi">üîÑ</button>
            </div>
            <div class="lixi-grid" id="lixi-grid"></div>
        </div>
    </div>

    <script>
        $(function() {
            let currentConfig = {
                total: 1000000,
                count: 10,
                min: 20000,
                max: 200000,
                amounts: []
            };

            // Format Helpers
            function formatNumber(n) {
                return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }

            function parseFormattedNumber(s) {
                return parseInt(s.replace(/\./g, '')) || 0;
            }

            $(document).on('input', '.money-input', function() {
                let val = $(this).val();
                let numeric = val.replace(/\D/g, '');
                if (numeric) {
                    $(this).val(formatNumber(parseInt(numeric)));
                } else {
                    $(this).val('');
                }
            });

            // Core Logic
            function calculateAmounts(total, count, min, max) {
                if (total % 10000 !== 0 || min % 10000 !== 0 || max % 10000 !== 0) {
                    alert("C√°c gi√° tr·ªã ti·ªÅn ph·∫£i chia h·∫øt cho 10.000ƒë ƒë·ªÉ ƒë√∫ng phong t·ª•c!");
                    return null;
                }
                
                const U_TOTAL = total / 10000;
                const U_MIN = min / 10000;
                const U_MAX = max / 10000;

                const minSum = (count * U_MIN) + (count * (count - 1) / 2);
                const maxSum = (count * U_MAX) - (count * (count - 1) / 2);

                if (U_TOTAL < minSum || U_TOTAL > maxSum) {
                    alert(`L·ªói: Kh√¥ng th·ªÉ chia ti·ªÅn v·ªõi c·∫•u h√¨nh n√†y.\nV·ªõi ${count} ng∆∞·ªùi, t·ªïng ti·ªÅn ph·∫£i t·ª´ ${formatNumber(minSum * 10000)}ƒë ƒë·∫øn ${formatNumber(maxSum * 10000)}ƒë`);
                    return null;
                }

                let units = [];
                for (let i = 0; i < count; i++) {
                    units.push(U_MIN + i);
                }

                let currentSum = units.reduce((a, b) => a + b, 0);
                let deficit = U_TOTAL - currentSum;

                while (deficit > 0) {
                    let changed = false;
                    for (let i = count - 1; i >= 0; i--) {
                        if (deficit <= 0) break;
                        const upperLimit = (i === count - 1) ? U_MAX : units[i + 1] - 1;
                        const canAdd = upperLimit - units[i];
                        if (canAdd > 0) {
                            const add = Math.min(canAdd, deficit);
                            units[i] += add;
                            deficit -= add;
                            changed = true;
                        }
                    }
                    if (!changed) break;
                }

                return units.map(u => u * 10000);
            }

            function updatePreview() {
                const totalInput = parseFormattedNumber($('#total-amount').val());
                const count = parseInt($('#envelope-count').val());
                const min = parseFormattedNumber($('#min-val').val());
                const max = parseFormattedNumber($('#max-val').val());

                const result = calculateAmounts(totalInput, count, min, max);
                if (result) {
                    currentConfig = { total: totalInput, count, min, max, amounts: result };
                    const actualTotal = result.reduce((a, b) => a + b, 0);
                    $('#preview-total').text(`T·ªïng c·ªông: ${formatNumber(actualTotal)}ƒë`);

                    const $list = $('#preview-list');
                    $list.empty();
                    [...result].sort(() => Math.random() - 0.5).forEach(amt => {
                        $list.append(`<div class="preview-item">${formatNumber(amt)}ƒë</div>`);
                    });
                    $('#preview-container').fadeIn();
                    return true;
                }
                return false;
            }

            function createConfetti() {
                const colors = ['#f44336', '#ffcf33', '#ffa000', '#ffffff', '#ff1744'];
                for (let i = 0; i < 25; i++) {
                    const $c = $('<div class="confetti"></div>');
                    const startX = Math.random() * window.innerWidth;
                    const startY = -20;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    $c.css({
                        left: startX,
                        top: startY,
                        backgroundColor: color,
                        transform: `rotate(${Math.random() * 360}deg)`
                    });
                    
                    $('body').append($c);
                    
                    $c.animate({
                        top: window.innerHeight + 20,
                        left: startX + (Math.random() - 0.5) * 200,
                        opacity: 0
                    }, 800 + Math.random() * 1200, function() {
                        $(this).remove();
                    });
                }
            }

            // Events
            $('#btn-suggest').on('click', () => {
                const total = parseFormattedNumber($('#total-amount').val()) || 1000000;
                const count = parseInt($('#envelope-count').val()) || 10;
                const avg = total / count;
                const suggestedMin = Math.max(10000, Math.floor((avg * 0.4) / 10000) * 10000);
                const suggestedMax = Math.floor((avg * 1.8) / 10000) * 10000;
                $('#min-val').val(formatNumber(suggestedMin));
                $('#max-val').val(formatNumber(suggestedMax));
                updatePreview();
            });

            $('#btn-save').on('click', () => {
                if (updatePreview()) {
                    localStorage.setItem('lixi_config_standalone', JSON.stringify({
                        total: currentConfig.total,
                        count: currentConfig.count,
                        min: currentConfig.min,
                        max: currentConfig.max
                    }));
                    alert("ƒê√£ l∆∞u c·∫•u h√¨nh!");
                }
            });

            $('#btn-start-game').on('click', () => {
                if (updatePreview()) {
                    $('#setup-screen').fadeOut(200);
                    $('#main-header').fadeOut(200, () => {
                        $('#game-screen').fadeIn();
                        renderGame();
                        window.scrollTo(0, 0);
                    });
                }
            });

            $('#btn-back').on('click', () => {
                $('#game-screen').fadeOut(200, () => {
                    $('#main-header').fadeIn(200);
                    $('#setup-screen').fadeIn(200);
                });
            });

            $('#btn-shuffle').on('click', () => {
                $('.lixi-wrapper').removeClass('open');
                setTimeout(() => renderGame(), 300);
            });

            function renderGame() {
                const $grid = $('#lixi-grid');
                const count = currentConfig.count;
                $grid.empty().removeClass('grid-small grid-medium grid-large');
                
                if (count <= 12) {
                    $grid.addClass('grid-small');
                    $grid.css('grid-template-columns', 'repeat(auto-fit, minmax(100px, 1fr))');
                } else if (count <= 24) {
                    $grid.addClass('grid-medium');
                    $grid.css('grid-template-columns', 'repeat(auto-fit, minmax(70px, 1fr))');
                } else {
                    $grid.addClass('grid-large');
                    const minW = window.innerWidth < 480 ? '55px' : '70px';
                    $grid.css('grid-template-columns', `repeat(auto-fit, minmax(${minW}, 1fr))`);
                }
                
                const gameAmounts = [...currentConfig.amounts].sort(() => Math.random() - 0.5);

                gameAmounts.forEach((amt) => {
                    const html = `
                        <div class="lixi-wrapper">
                            <div class="lixi-card">
                                <div class="lixi-front"></div>
                                <div class="lixi-back">
                                    <div class="amount-text">${formatNumber(amt)}ƒë</div>
                                    <div class="congrats-text">An khang th·ªãnh v∆∞·ª£ng</div>
                                </div>
                            </div>
                        </div>
                    `;
                    const $el = $(html);
                    $grid.append($el);

                    $el.on('click', function() {
                        if ($(this).hasClass('open')) return;
                        $(this).addClass('open').find('.lixi-card').addClass('animate-pop');
                        createConfetti();
                    });
                });
            }

            // Init
            const saved = localStorage.getItem('lixi_config_standalone');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    $('#total-amount').val(formatNumber(config.total));
                    $('#envelope-count').val(config.count);
                    $('#min-val').val(formatNumber(config.min));
                    $('#max-val').val(formatNumber(config.max));
                    updatePreview();
                } catch (e) { updatePreview(); }
            } else { updatePreview(); }
        });
    </script>
</body>
</html>
